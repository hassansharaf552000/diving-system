<div class="code-page">
  <div class="code-card">
    <div class="code-toolbar">
      <div class="toolbar-left">
        <button class="back-btn" (click)="goBack()">‚Üê</button>
        <h2>ü§ø Entry Transaction</h2>
        <span class="record-count">{{ transactions.length }} records</span>
      </div>
      <div class="toolbar-right">
        <button class="btn-add" (click)="openAdd()">Ôºã Add New Transaction</button>
      </div>
    </div>
    
    <div class="code-table-wrap">
      <div class="table-search">
        <span class="search-icon">üîç</span>
        <input type="text" [(ngModel)]="searchTerm" placeholder="Search transactions..." (keyup.enter)="searchTransactions()">
      </div>
      
      <table class="code-table">
        <thead>
          <tr>
            <th>Voucher</th>
            <th>Date</th>
            <th>Rep Name</th>
            <th>Excursion Name</th>
            <th>Pax (A/C/I)</th>
            <th>Excursion Supplier</th>
            <th style="width:90px">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tx of transactions">
            <td><strong>{{ tx.voucherNumber }}</strong></td>
            <td>{{ tx.transactionDate | date:'dd-MM-yyyy' }}</td>
            <td>{{ tx.repName }}</td>
            <td>{{ tx.excursionName }}</td>
            <td class="num-cell">{{ tx.adl }} / {{ tx.chd }} / {{ tx.inf }}</td>
            <td>{{ tx.excursionSupplierName || '-' }}</td>
            <td>
              <div class="actions-cell">
                <button class="action-btn edit-btn" (click)="openEdit(tx)" title="Edit">‚úèÔ∏è</button>
                <button class="action-btn delete-btn" (click)="confirmDelete(tx)" title="Delete">üóëÔ∏è</button>
              </div>
            </td>
          </tr>
          <tr *ngIf="transactions.length === 0">
            <td colspan="7" class="empty-row">No transactions found</td>
          </tr>
        </tbody>
      </table>
      
      <div class="table-footer">
        <span class="records-info">Showing {{ transactions.length }} records</span>
        <app-export-buttons [data]="transactions"></app-export-buttons>             
      </div>
    </div>            
  </div>

  <!-- Add/Edit Modal (reusing the same form structure but editable) -->
  <app-modal [title]="isEdit ? 'Edit Transaction' : 'Add New Transaction'" [isOpen]="isModalOpen" (closed)="closeModal()" size="large">
    <div class="modal-form">
      
      <!-- General Form Area -->
      <div class="form-row">
        <div class="form-group">
          <label>Voucher *</label>
          <input type="text" [(ngModel)]="model.voucherNumber">
        </div>
        <div class="form-group">
          <label>Date *</label>
          <input type="date" [(ngModel)]="model.transactionDate">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Rep</label>
          <select [(ngModel)]="model.repId">
            <option [ngValue]="undefined">-</option>
            <option *ngFor="let r of reps" [ngValue]="r.id">{{ r.repName }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Agent</label>
          <select [(ngModel)]="model.agentId">
            <option [ngValue]="undefined">-</option>
            <option *ngFor="let a of agents" [ngValue]="a.id">{{ a.agentName }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Nationality</label>
          <select [(ngModel)]="model.nationalityId">
            <option [ngValue]="undefined">-</option>
            <option *ngFor="let n of nationalities" [ngValue]="n.id">{{ n.nationalityName }}</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Hotel</label>
          <select [(ngModel)]="model.hotelId">
            <option [ngValue]="undefined">-</option>
            <option *ngFor="let h of hotels" [ngValue]="h.id">{{ h.hotelName }}</option>
          </select>
        </div>
        <div class="form-group" style="display: flex; gap: 5px;">
          <div style="flex: 1;">
            <label>Room</label>
            <input type="text" [(ngModel)]="model.roomNumber" placeholder="Room">
          </div>
          <div style="flex: 1;">
            <label>Pick Up</label>
            <input type="time" [(ngModel)]="model.pickUpTime">
          </div>
        </div>
        <div class="form-group">
          <label>Destination</label>
          <select [(ngModel)]="model.hotelDestinationId">
            <option [ngValue]="undefined">-</option>
            <option *ngFor="let d of destinations" [ngValue]="d.id">{{ d.destinationName }}</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Excursion</label>
          <select [(ngModel)]="model.excursionId">
            <option [ngValue]="undefined">-</option>
            <option *ngFor="let e of excursions" [ngValue]="e.id">{{ e.excursionName }}</option>
          </select>
        </div>
        <div class="form-group" style="display: flex; gap: 5px;">
          <div style="flex: 1;">
            <label>ADL</label>
            <input type="number" [(ngModel)]="model.adl" min="0">
          </div>
          <div style="flex: 1;">
            <label>CHD</label>
            <input type="number" [(ngModel)]="model.chd" min="0">
          </div>
          <div style="flex: 1;">
            <label>INF</label>
            <input type="number" [(ngModel)]="model.inf" min="0">
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Supplier</label>
          <select [(ngModel)]="model.excursionSupplierId">
            <option [ngValue]="undefined">-</option>
            <option *ngFor="let s of suppliers" [ngValue]="s.id">{{ s.supplierName }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Price List</label>
          <select [(ngModel)]="model.priceListId">
            <option [ngValue]="undefined">-</option>
            <option *ngFor="let p of priceLists" [ngValue]="p.id">{{ p.priceListName }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Payment</label>
          <select [(ngModel)]="model.paymentType">
            <option *ngFor="let pt of paymentTypes" [ngValue]="pt">{{ pt }}</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group" style="flex: 1;">
          <label>Note</label>
          <input type="text" [(ngModel)]="model.note" placeholder="Optional notes" style="width: 100%;">
        </div>
      </div>

      <hr style="margin: 15px 0; border: 0; border-top: 1px dashed #ccc;">

      <!-- Financial edits in modal -->
      <div class="modal-financial-grid">
        <table class="fin-table">
          <thead>
            <tr>
              <th>Type</th>
              <th>Date</th>
              <th>Rec No</th>
              <th>EGP</th>
              <th>USD</th>
              <th>EUR</th>
              <th>GBP</th>
              <th>Free</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>Revenue</td>
              <td><input type="date" class="cell-input" [(ngModel)]="model.revenueDate"></td>
              <td><input type="text" class="cell-input" [(ngModel)]="model.revenueRecNo"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.revenueEGP" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.revenueUSD" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.revenueEUR" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.revenueGBP" step="0.01"></td>
              <td class="text-center"><input type="checkbox" [(ngModel)]="model.revenueFree"></td>
            </tr>
            <tr>
              <td>Refund</td>
              <td><input type="date" class="cell-input" [(ngModel)]="model.refundDate"></td>
              <td><input type="text" class="cell-input" [(ngModel)]="model.refundRecNo"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.refundEGP" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.refundUSD" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.refundEUR" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.refundGBP" step="0.01"></td>
              <td class="text-center"><input type="checkbox" [(ngModel)]="model.refundFree"></td>
            </tr>
            <tr>
              <td>Discount</td>
              <td colspan="2"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.discountEGP" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.discountUSD" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.discountEUR" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.discountGBP" step="0.01"></td>
              <td class="text-center"><input type="checkbox" [(ngModel)]="model.discountFree"></td>
            </tr>
            <tr>
              <td>Selling</td>
              <td colspan="2"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.sellingEGP" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.sellingUSD" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.sellingEUR" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.sellingGBP" step="0.01"></td>
              <td class="text-center"><input type="checkbox" [(ngModel)]="model.sellingFree"></td>
            </tr>
            <tr>
              <td>Cost</td>
              <td colspan="2"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.costEGP" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.costUSD" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.costEUR" step="0.01"></td>
              <td><input type="number" class="cell-input num" [(ngModel)]="model.costGBP" step="0.01"></td>
              <td class="text-center"><input type="checkbox" [(ngModel)]="model.costFree"></td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
    <div class="modal-footer">
      <button class="btn-save" (click)="save()" [disabled]="saving">{{ isEdit ? 'üíæ Update' : 'Ôºã Add Transaction' }}</button>
      <button class="btn-cancel-modal" (click)="closeModal()">Cancel</button>
    </div>
  </app-modal>

  <!-- Delete Confirmation -->
  <app-confirm-dialog
    [isOpen]="showDeleteConfirm"
    [itemName]="'Transaction voucher ' + (deleteTarget?.voucherNumber || '')"
    (confirmed)="onDeleteConfirmed()"
    (cancelled)="onDeleteCancelled()">
  </app-confirm-dialog>

</div>
